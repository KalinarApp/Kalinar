name: Build Flutter for Windows and publish to Windows Store

on: 
  push:
    paths: 
      - ".github/workflows/android.yml"
  # branches: [ "main" ]
    
jobs:
  build:
    steps:
    - uses: actions/checkout@v3
    
    - uses: actions/setup-java@v2
      with:
        distribution: 'zulu'
        java-version: '11'
      
    - name: Support longpaths
      run: git config --system core.longpaths true

    - name: Install Flutter
      uses: subosito/flutter-action@v2.8.0
      with:
        cache: true
        
    - name: Restore packages
      working-directory: ./Client
      run: flutter pub get
      
    - name: Generate build number
      id: buildnumber
      uses: onyxmueller/build-tag-number@v1
      with:
        token: ${{secrets.github_token}} 
    
    - name: Build for Android
      working-directory: ./Client
      run: flutter build appbundle --dart-define=SENTRY_DSN=${{ env.SENTRY_DNS }} --flavor=prod --release --no-tree-shake-icons --build-number=${env:BUILD_NUMBER}
      
    - uses: r0adkll/sign-android-release@v1
      name: Sign app APK
      id: sign_app
      with:
        releaseDirectory: ./Client/build/app/outputs/bundle/prodRelease
        signingKeyBase64: ${{ secrets.GOOGLE_PLAY_SIGNING_KEY }}
        alias: ${{ env.GOOGLE_PLAY_SIGNING_KEY_ALIAS }}
        keyStorePassword: ${{ secrets.GOOGLE_PLAY_SIGNING_KEY_STORE_PASSWORD }}
        keyPassword: ${{ secrets.GOOGLE_PLAY_SIGNING_KEY_PASSWORD }}
        
    - uses: actions/upload-artifact@v2
      name: Upload android appbundle artifact 
      with:
        name: Signed app bundle
        path: ${{steps.sign_app.outputs.signedReleaseFile}}
